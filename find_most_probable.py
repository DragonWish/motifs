#prokaryotic 20
hpt_profile={'A': [0.11666666666666667, 0.1125, 0.075, 0.21666666666666667, 0.49583333333333335, 0.004166666666666667, 0.0625, 0.004166666666666667, 0.05416666666666667, 0.004166666666666667, 0.2375, 0.5291666666666667, 0.2791666666666667, 0.07916666666666666, 0.07916666666666666, 0.041666666666666664, 0.25833333333333336, 0.04583333333333333, 0.16666666666666666, 0.05], 
            'C': [0.029166666666666667, 0.0125, 0.004166666666666667, 0.020833333333333332, 0.008333333333333333, 0.004166666666666667, 0.004166666666666667, 0.004166666666666667, 0.004166666666666667, 0.004166666666666667, 0.025, 0.075, 0.020833333333333332, 0.0125, 0.041666666666666664,0.008333333333333333, 0.0125, 0.004166666666666667, 0.004166666666666667, 0.004166666666666667], 
            'E': [0.004166666666666667, 0.04583333333333333, 0.09583333333333334, 0.1, 0.004166666666666667, 0.004166666666666667, 0.004166666666666667, 0.004166666666666667, 0.004166666666666667, 0.004166666666666667, 0.0125, 0.004166666666666667, 0.008333333333333333, 0.004166666666666667, 0.004166666666666667,0.07083333333333333, 0.004166666666666667, 0.09166666666666666, 0.125, 0.004166666666666667], 
            'D': [0.004166666666666667, 0.0375, 0.0625, 0.05, 0.004166666666666667, 0.008333333333333333, 0.0125, 0.004166666666666667, 0.008333333333333333,0.008333333333333333, 0.0125, 0.004166666666666667, 0.008333333333333333, 0.008333333333333333, 0.004166666666666667, 0.05416666666666667, 0.004166666666666667, 0.09583333333333334, 0.06666666666666667, 0.008333333333333333], 
            'G': [0.016666666666666666, 0.041666666666666664, 0.016666666666666666, 0.041666666666666664,0.020833333333333332, 0.004166666666666667, 0.020833333333333332, 0.004166666666666667, 0.029166666666666667, 0.8916666666666667, 0.175, 0.04583333333333333, 0.32083333333333336, 0.008333333333333333, 0.004166666666666667, 0.7125, 0.008333333333333333, 0.025, 0.041666666666666664, 0.029166666666666667], 
            'F': [0.008333333333333333, 0.23333333333333334, 0.029166666666666667, 0.0125, 0.04583333333333333, 0.004166666666666667, 0.016666666666666666, 0.05, 0.004166666666666667, 0.004166666666666667, 0.004166666666666667, 0.0375, 0.004166666666666667, 0.0625, 0.15416666666666667, 0.004166666666666667, 0.12916666666666668, 0.0125, 0.020833333333333332, 0.0125], 
            'I': [0.25, 0.05416666666666667, 0.008333333333333333, 0.07916666666666666, 0.0625, 0.004166666666666667, 0.008333333333333333, 0.22916666666666666, 0.004166666666666667, 0.004166666666666667, 0.004166666666666667, 0.008333333333333333, 0.004166666666666667, 0.04583333333333333, 0.1125, 0.004166666666666667, 0.05, 0.03333333333333333, 0.020833333333333332, 0.175], 
            'H': [0.004166666666666667, 0.016666666666666666, 0.0625, 0.04583333333333333, 0.004166666666666667, 0.9833333333333333, 0.008333333333333333, 0.004166666666666667, 0.08333333333333333, 0.0125, 0.004166666666666667, 0.004166666666666667, 0.025, 0.020833333333333332, 0.008333333333333333, 0.0125, 0.008333333333333333, 0.03333333333333333, 0.041666666666666664, 0.004166666666666667], 
            'K': [0.008333333333333333, 0.075, 0.016666666666666666, 0.004166666666666667, 0.004166666666666667, 0.004166666666666667, 0.15, 0.004166666666666667, 0.7333333333333333, 0.004166666666666667, 0.004166666666666667, 0.004166666666666667, 0.016666666666666666, 0.004166666666666667, 0.004166666666666667, 0.0125, 0.004166666666666667, 0.0625, 0.05, 0.008333333333333333], 
            'M': [0.041666666666666664,0.03333333333333333, 0.004166666666666667, 0.020833333333333332, 0.020833333333333332, 0.004166666666666667, 0.004166666666666667, 0.029166666666666667, 0.004166666666666667, 0.004166666666666667, 0.06666666666666667, 0.008333333333333333, 0.008333333333333333, 0.18333333333333332, 0.09583333333333334, 0.004166666666666667, 0.041666666666666664,0.0375, 0.008333333333333333, 0.07083333333333333], 
            'L': [0.3625, 0.1, 0.0375, 0.15833333333333333, 0.175, 0.004166666666666667, 0.004166666666666667, 0.6208333333333333, 0.004166666666666667, 0.004166666666666667, 0.029166666666666667, 0.07083333333333333, 0.03333333333333333, 0.0625, 0.30416666666666664, 0.008333333333333333, 0.3416666666666667, 0.04583333333333333, 0.029166666666666667, 0.49583333333333335], 
            'N': [0.004166666666666667, 0.008333333333333333, 0.0375, 0.03333333333333333, 0.004166666666666667, 0.008333333333333333, 0.008333333333333333,0.004166666666666667, 0.016666666666666666, 0.008333333333333333, 0.0125, 0.004166666666666667, 0.008333333333333333, 0.09166666666666666, 0.004166666666666667, 0.0375, 0.016666666666666666, 0.058333333333333334, 0.025, 0.004166666666666667], 
            'Q': [0.004166666666666667, 0.07083333333333333, 0.058333333333333334, 0.0375, 0.004166666666666667, 0.004166666666666667, 0.0875, 0.004166666666666667, 0.025, 0.004166666666666667, 0.008333333333333333, 0.004166666666666667, 0.016666666666666666, 0.0125, 0.004166666666666667, 0.029166666666666667, 0.004166666666666667, 0.0625, 0.10416666666666667, 0.008333333333333333], 
            'P': [0.008333333333333333, 0.004166666666666667, 0.008333333333333333, 0.004166666666666667, 0.004166666666666667, 0.004166666666666667, 0.004166666666666667, 0.004166666666666667, 0.004166666666666667, 0.004166666666666667, 0.008333333333333333, 0.004166666666666667, 0.004166666666666667, 0.004166666666666667, 0.004166666666666667, 0.008333333333333333, 0.008333333333333333, 0.14166666666666666, 0.0875, 0.016666666666666666], 
            'S': [0.020833333333333332, 0.04583333333333333, 0.06666666666666667, 0.05416666666666667, 0.041666666666666664, 0.008333333333333333, 0.1625, 0.004166666666666667, 0.020833333333333332, 0.09583333333333334, 0.3458333333333333, 0.22916666666666666, 0.11666666666666667, 0.2, 0.03333333333333333, 0.03333333333333333, 0.016666666666666666, 0.0625, 0.058333333333333334, 0.004166666666666667],
            'R': [0.004166666666666667, 0.10833333333333334, 0.475, 0.029166666666666667, 0.004166666666666667, 0.004166666666666667, 0.15416666666666667, 0.004166666666666667, 0.05, 0.008333333333333333, 0.004166666666666667, 0.004166666666666667, 0.175, 0.004166666666666667, 0.004166666666666667, 0.020833333333333332, 0.008333333333333333, 0.0625, 0.15, 0.004166666666666667], 
            'T': [0.020833333333333332, 0.025, 0.008333333333333333, 0.07916666666666666, 0.0125, 0.0125, 0.35, 0.016666666666666666, 0.008333333333333333, 0.004166666666666667, 0.058333333333333334, 0.025, 0.0125, 0.15416666666666667, 0.020833333333333332, 0.004166666666666667, 0.016666666666666666, 0.1125, 0.05, 0.025], 
            'W': [0.004166666666666667, 0.008333333333333333, 0.004166666666666667, 0.004166666666666667, 0.004166666666666667, 0.004166666666666667, 0.0125, 0.004166666666666667, 0.004166666666666667, 0.004166666666666667, 0.004166666666666667, 0.004166666666666667, 0.004166666666666667,0.004166666666666667, 0.004166666666666667, 0.008333333333333333, 0.004166666666666667, 0.008333333333333333, 0.004166666666666667, 0.004166666666666667], 
            'V':[0.1625, 0.041666666666666664, 0.008333333333333333, 0.0625, 0.15833333333333333, 0.004166666666666667, 0.004166666666666667, 0.075, 0.0125, 0.004166666666666667, 0.0625, 0.0125, 0.0125, 0.03333333333333333, 0.19166666666666668, 0.004166666666666667, 0.1, 0.0625, 0.020833333333333332, 0.14583333333333334], 
            'Y': [0.008333333333333333, 0.008333333333333333, 0.004166666666666667, 0.029166666666666667, 0.004166666666666667, 0.004166666666666667, 0.004166666666666667, 0.008333333333333333, 0.008333333333333333, 0.004166666666666667, 0.004166666666666667, 0.004166666666666667, 0.004166666666666667, 0.0875, 0.004166666666666667, 0.004166666666666667, 0.04583333333333333, 0.025, 0.008333333333333333, 0.008333333333333333]}
k=20
#eukaryotic 20
hpt_profile_e={'A': [0.009765625, 0.009765625, 0.08984375, 0.033203125, 0.14453125, 0.029296875, 0.14453125, 0.02734375, 0.16796875, 0.005859375, 0.009765625, 0.013671875, 0.00390625, 0.0078125, 0.021484375, 0.091796875, 0.6875, 0.11328125, 0.0078125, 0.328125],
             'C': [0.00390625, 0.001953125, 0.005859375, 0.001953125, 0.001953125, 0.00390625, 0.001953125, 0.0078125, 0.009765625, 0.001953125, 0.001953125, 0.001953125, 0.001953125, 0.001953125, 0.01171875, 0.033203125, 0.009765625, 0.005859375, 0.001953125, 0.001953125],
             'E': [0.01953125, 0.009765625, 0.06640625, 0.12890625, 0.00390625, 0.01953125, 0.037109375, 0.31640625, 0.001953125, 0.0078125, 0.001953125, 0.009765625, 0.001953125, 0.005859375, 0.00390625, 0.005859375, 0.00390625, 0.001953125, 0.00390625, 0.01171875],
             'D': [0.7890625, 0.00390625, 0.099609375, 0.0234375, 0.001953125, 0.306640625, 0.03515625, 0.0234375, 0.001953125, 0.00390625, 0.0078125, 0.001953125, 0.0078125, 0.005859375, 0.001953125, 0.00390625, 0.005859375, 0.0078125, 0.001953125, 0.005859375],
             'G': [0.009765625, 0.001953125, 0.015625, 0.005859375, 0.00390625, 0.04296875, 0.017578125, 0.01171875, 0.275390625, 0.001953125, 0.00390625, 0.00390625, 0.005859375, 0.953125, 0.03125, 0.017578125, 0.009765625, 0.005859375, 0.009765625, 0.626953125],
             'F': [0.0078125, 0.4921875, 0.005859375, 0.00390625, 0.009765625, 0.015625, 0.001953125, 0.015625, 0.00390625, 0.00390625, 0.244140625, 0.109375, 0.00390625, 0.001953125, 0.00390625, 0.00390625, 0.00390625, 0.00390625, 0.03125, 0.00390625],
             'I': [0.001953125, 0.103515625, 0.01171875, 0.001953125, 0.083984375, 0.009765625, 0.021484375, 0.021484375, 0.005859375, 0.01171875, 0.001953125, 0.02734375, 0.005859375, 0.005859375, 0.001953125, 0.00390625, 0.005859375, 0.00390625, 0.248046875, 0.00390625],
             'H': [0.001953125, 0.001953125, 0.0078125, 0.0078125, 0.0078125, 0.001953125, 0.005859375, 0.142578125, 0.00390625, 0.8828125, 0.001953125, 0.001953125, 0.00390625, 0.001953125, 0.0078125, 0.001953125, 0.00390625, 0.001953125, 0.001953125, 0.00390625],
             'K': [0.0078125, 0.00390625, 0.1953125, 0.21875, 0.001953125, 0.00390625, 0.01171875, 0.0078125, 0.005859375, 0.005859375, 0.0234375, 0.0078125, 0.927734375, 0.001953125, 0.001953125, 0.00390625, 0.005859375, 0.0078125, 0.001953125, 0.0078125],
             'M': [0.001953125, 0.0078125, 0.005859375, 0.001953125, 0.04296875, 0.00390625, 0.001953125, 0.005859375, 0.08984375, 0.00390625, 0.00390625, 0.001953125, 0.013671875, 0.001953125, 0.001953125, 0.00390625, 0.001953125, 0.009765625, 0.0078125, 0.005859375],
             'L': [0.00390625, 0.28515625, 0.029296875, 0.037109375, 0.421875, 0.00390625, 0.02734375, 0.302734375, 0.03515625, 0.0078125, 0.0078125, 0.814453125, 0.01171875, 0.005859375, 0.00390625, 0.0078125, 0.001953125, 0.005859375, 0.283203125, 0.005859375],
             'N': [0.107421875, 0.001953125, 0.083984375, 0.013671875, 0.005859375, 0.0078125, 0.03515625, 0.01171875, 0.001953125, 0.025390625, 0.009765625, 0.00390625, 0.005859375, 0.001953125, 0.001953125, 0.001953125, 0.001953125, 0.017578125, 0.0078125, 0.0078125],
             'Q': [0.017578125, 0.0078125, 0.048828125, 0.07421875, 0.001953125, 0.0234375, 0.06640625, 0.001953125, 0.00390625, 0.04296875, 0.3046875, 0.00390625, 0.0078125, 0.001953125, 0.005859375, 0.001953125, 0.005859375, 0.0078125, 0.00390625, 0.001953125],
             'P': [0.001953125, 0.00390625, 0.009765625, 0.00390625, 0.001953125, 0.005859375, 0.0078125, 0.001953125, 0.00390625, 0.0078125, 0.00390625, 0.001953125, 0.00390625, 0.001953125, 0.0078125, 0.005859375, 0.001953125, 0.001953125, 0.001953125, 0.00390625],
             'S': [0.013671875, 0.01171875, 0.04296875, 0.009765625, 0.01171875, 0.19921875, 0.205078125, 0.02734375, 0.16796875, 0.00390625, 0.32421875, 0.005859375, 0.001953125, 0.025390625, 0.912109375, 0.826171875, 0.25390625, 0.330078125, 0.00390625, 0.001953125],
             'R': [0.017578125, 0.0078125, 0.013671875, 0.107421875, 0.0078125, 0.3203125, 0.357421875, 0.0078125, 0.00390625, 0.005859375, 0.0234375, 0.0078125, 0.013671875, 0.001953125, 0.005859375, 0.001953125, 0.0078125, 0.00390625, 0.00390625, 0.005859375],
             'T': [0.0078125, 0.009765625, 0.072265625, 0.193359375, 0.083984375, 0.01953125, 0.04296875, 0.013671875, 0.060546875, 0.001953125, 0.021484375, 0.005859375, 0.00390625, 0.00390625, 0.0078125, 0.013671875, 0.01171875, 0.177734375, 0.005859375, 0.00390625],
             'W': [0.001953125, 0.001953125, 0.001953125, 0.001953125, 0.033203125, 0.001953125, 0.00390625, 0.001953125, 0.001953125, 0.00390625, 0.001953125, 0.001953125, 0.001953125, 0.001953125, 0.001953125, 0.001953125, 0.001953125, 0.001953125, 0.001953125, 0.001953125],
             'V': [0.00390625, 0.001953125, 0.203125, 0.166015625, 0.1640625, 0.0078125, 0.009765625, 0.01171875, 0.19140625, 0.001953125, 0.0078125, 0.00390625, 0.009765625, 0.00390625, 0.001953125, 0.001953125, 0.0078125, 0.0078125, 0.408203125, 0.001953125],
             'Y': [0.009765625, 0.0703125, 0.029296875, 0.00390625, 0.00390625, 0.01171875, 0.00390625, 0.078125, 0.001953125, 0.0078125, 0.033203125, 0.009765625, 0.001953125, 0.001953125, 0.001953125, 0.005859375, 0.005859375, 0.322265625, 0.001953125, 0.00390625]}
k_e=20

import math
import numpy as np
import pylab as pl
import matplotlib.pyplot as plt
import matplotlib.patches as patches
import matplotlib.path as path
import time
import operator
import random

def transpose(m):
    mT=[[]for x in m[0]]
    for i in range(0,len(m[0])):
        for j in range(0,len(m)):
            mT[i].append(m[j][i])
    return mT

def scramble_profile(prof,k):
    values=prof.values()
    aas=prof.keys()
    vT=transpose(values)
    random.shuffle(vT)
    v=transpose(vT)
    scrambled_prof={aas[i]:v[i] for i in range(0,k)}
    return scrambled_prof

#probability of a kmer occurring, given a profile p
def probability(kmer,p):
    prob=1
    for i in range(0,len(kmer)):
        try:
            prob=prob*p[kmer[i]][i]
        except KeyError:
            prob=0
    return prob

#returns most probable kmer in a given sequence, according
#to profile p
def most_probable(seq,k,p):
    k_most_probable=""
    maxp=-1
    for i in range(0,len(seq)-k):
        kmer=seq[i:i+k]
        probability=1
        for j in range(0,k):
            try:
                probability=probability*p[kmer[j]][j]
            except KeyError:pass
        if probability>maxp:
            maxp=probability
            k_most_probable=kmer
    return k_most_probable,maxp

#opens and reads a fasta file (filename), returns dictionary mapping each
#title (>...) to its corresponding protein sequence.
def read_sequences(filename):
    f=open(filename)
    lines=f.readlines()
    f.close()
    titles={}
    for i in lines:
        if i[0]==">":
            title=i[:-1]
            titles[title]=""
        else:
            titles[title]+=i.replace("X","A")[:-1]
    return titles
#rdea="MISDYEGPTPTKKFDQDILFDYSEGEKEFTFELLDSYISSVEEHLPELLNSFEAKDLKGAVLHSHDIKGSSSYIGCEAVRYVSGKIEAYCKNDELEKAESFYPELKKEVEEVFKILSDFKKNWDKNHGEGGSDDGGDDNESEPTENNNNDGSSVNNNDSSSGGGGKDIENKNTDENTGKNLNERSKSPVPLQTTLKPVTIETPKTASDKIATETPTSLANNTNSSSNNNSKNENGLNSKQPQTSSNSPTKIQTK"

##print top 25 sequences in the sorted dictionary
##for i in sorted_scores[:25]:
##    prob_motif=most_probable(i[0],k,hpt_profile)[0]
##    print str(i[1])+"\t"+prob_motif+"\t"+str(titles.keys()[titles.values().index(i[0])])

def histogram(scores,high,low): #histogram of scores
    fig,ax=plt.subplots()
    low=int(math.log(low[1],10))
    high=int(math.log(high[1],10))
    data = scores.values()
    pl.hist(data, bins=np.logspace(low, high, 50))
    pl.gca().set_xscale("log")
    pl.show()

def boxplot(scores, titles):    #boxplot of logged scores, whiskers at 3IQR
    logged_data=[[] for i in scores]
    for i in range(0,len(scores)):
        for j in scores[i]:
            if j>0:
                logged_data[i].append(math.log(j,10))
    r=plt.boxplot(logged_data, whis=3)

    pl.xticks(range(1,len(scores)+1),titles)
    plt.show()
    #print the number of outliers
    print str(len(r["fliers"][0].get_data()[1]))+" outliers"

#generate the scrambled profiles
scrambled_hpt_e=scramble_profile(hpt_profile_e,k)
scrambled_hpt_p=scramble_profile(hpt_profile,k)

def main(proteome,prof):
    x1=time.time()
    titles=read_sequences(proteome)
    proteins=titles.values()
    maxp=0
    scores={}
    for i in proteins:
        kmer,prob=most_probable(i,k,prof)
        scores[i]=prob

    #sorted_scores=sorted(scores.iteritems(),key=operator.itemgetter(1), reverse=True)

    print str(time.time()-x1)+"  elapsed"
    return scores, titles

if __name__=="__main__":
    organism_proteome="proteomes/15368.fasta"
    #hpt_family="PF01627_full.txt"
    #paz_family="PF02170_full.txt"
    scores_hpt, titles_hpt = main(organism_proteome,hpt_profile_e)
    #t=read_sequences(organism_proteome)
    #first20=[probability(i[1:21],hpt_profile) for i in t.values()]
    #first20_e=[probability(i[1:21],hpt_profile_e) for i in t.values()]
    
##    sorted_scores=sorted(scores.iteritems(),key=operator.itemgetter(1), reverse=True)
##    for i in sorted_scores[:25]:
##        print str(i[1])+"\t"+str(most_probable(i[0],k,hpt_profile)[0])+"\t"+str(titles.keys()[titles.values().index(i[0])])
##    boxplot(scores)
    boxplot([scores_hpt.values()],["P. pallidum"])
    
    
